# libc/tarn Makefile

VPATH  = @srcdir@
srcdir = @srcdir@
top_builddir = @top_builddir@

LIB_TYPE     = @LIB_TYPE@

SCC = $(top_builddir)/bin/sdcc -mtarn --max-allocs-per-node 25000
SAS = $(top_builddir)/bin/sdastarn

# override PORTDIR defined by super (parent) makefile
override PORTDIR = ../build/tarn

include $(srcdir)/../incl.mk

# Lack of shifting makes these difficult
TARN_FLOAT =
# $(COMMON_FLOAT)

TARN_INT = $(COMMON_INT) \
  _muluchar.c \
  _mulschar.c \
  _mulint.c \
  _divuchar.c \
  _divschar.c \
  _divuint.c \
  _divsint.c \
  _moduchar.c \
  _modschar.c \
  _moduint.c \
  _modsint.c

TARN_LONG = $(COMMON_LONG) \
  _divulong.c \
  _mullong.c

# Lack of shifting makes these difficult
# TARN_LONGLONG = $(COMMON_LONGLONG) \
#   _rrulonglong.c \
#   _rrslonglong.c \
#   _rlulonglong.c \
#   _rlslonglong.c \
#   _mullonglong.c \
#   _divslonglong.c \
#   _divulonglong.c \
#   _modslonglong.c \
#   _modulonglong.c


# These produce errors, so have been removed for now.
# ../bsearch.c:36: error 92: Functions called via pointers must be 'reentrant' to take this many (bytes for) arguments
# ../qsort.c:57: error 92: Functions called via pointers must be 'reentrant' to take this many (bytes for) arguments
# ../qsort.c:57: error 44: operands are not comparable
# ../rand.c:50: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1854' : Left shift by other than 1 or 8 not implemented. 
# ../mbtowc.c:71: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1823' : Left shift by other than 1 or 8 not implemented.
# ../c16rtomb.c:79: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1823' : Left shift by other than 1 or 8 not implemented. 
# ../c16stombs.c:87: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1823' : Left shift by other than 1 or 8 not implemented. 
# ../mbrtowc.c:101: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1823' : Left shift by other than 1 or 8 not implemented. 
# ../printf_large.c:872: error 9: FATAL Compiler Internal Error in file 'gen.c' line number '1823' : Left shift by other than 1 or 8 not implemented. 
# malloc.c:(code+0x5): undefined reference to `___sdcc_heap'
#   (even after explicitly adding _heap.c to the library... ??)

REDUCED_COMMON_SDCC = \
  isalnum.c \
  isalpha.c \
  isblank.c \
  iscntrl.c \
  isdigit.c \
  isgraph.c \
  islower.c \
  isprint.c \
  ispunct.c \
  isspace.c \
  isupper.c \
  isxdigit.c \
  tolower.c \
  toupper.c \
  atoi.c \
  atol.c \
  atoll.c \
  strtol.c \
  strtoul.c \
  abs.c \
  labs.c \
  _strcat.c \
  _strchr.c \
  _strcspn.c \
  strdup.c \
  strndup.c \
  _strncat.c \
  _strncmp.c \
  strxfrm.c \
  _strncpy.c \
  _strpbrk.c \
  _strrchr.c \
  _strspn.c \
  _strstr.c \
  _strtok.c \
  memccpy.c \
  _memchr.c \
  _memcmp.c \
  _memset.c \
  memset_explicit.c \
  aligned_alloc.c \
  calloc.c \
  realloc.c \
  free.c \
  mblen.c \
  wctomb.c \
  mbstowcs.c \
  wcstombs.c \
  mbrtoc16.c \
  mbrtoc32.c \
  c32rtomb.c \
  mbstoc16s.c \
  wcscmp.c \
  wcslen.c \
  btowc.c \
  wctob.c \
  mbsinit.c \
  mbrlen.c \
  wcrtomb.c \
  puts.c \
  gets.c \
  __assert.c \
  time.c


# bsearch.c produces
TARN_SDCC = $(REDUCED_COMMON_SDCC) \
  __itoa.c \
  _startup.c \
  _strcmp.c \
  _strcpy.c \
  _strlen.c \
  _memmove.c \
  __memcpy.c \
  memcpy.c \
  sprintf.c \
  vprintf.c

TARNSOURCES = $(addprefix ../,$(TARN_FLOAT) $(TARN_INT) $(TARN_LONG) $(TARN_LONGLONG) $(TARN_SDCC))
TARNOBJECTS = $(patsubst %.c,%.o,$(TARN_FLOAT) $(TARN_INT) $(TARN_LONG) $(TARN_LONGLONG) $(TARN_SDCC))

OBJ =
# __gptrget.rel __gptrget2.rel heap.rel __setjmp.rel

LIB = tarn.lib
CC = $(SCC)
AS = $(SAS)
ASFLAGS = -plosgff

CFLAGS = -I$(srcdir)/../../include -I. --std-c11

.SECONDARY: # don't rm all "intermediate" targets

all: $(PORTDIR)/$(LIB)

$(PORTDIR)/$(LIB): $(OBJ) $(TARNOBJECTS) Makefile
ifeq ($(LIB_TYPE), SDCCLIB)
	rm -f $@; \
	$(top_builddir)/bin/sdcclib -a $@ $(OBJ) $(TARNOBJECTS)
else
  ifeq ($(LIB_TYPE), AR)
	tarn-elf32-ar -rcSD $@ $(OBJ) $(TARNOBJECTS)
  else
    ifeq ($(LIB_TYPE), RANLIB)
	tarn-elf32-ar -rcD $@ $(OBJ) $(TARNOBJECTS)
    else
	rm -f $@
	for i in $(basename $(OBJ) $(TARNOBJECTS)); do echo $$i >>$@; done
	cp $(OBJ) $(TARNOBJECTS) $(PORTDIR)
    endif
  endif
endif

%.asm: %.c
	$(CC) -S $< -o $@

%.o: %.asm
	tarn-elf32-as $< -o $@

../%.asm: ../%.c
	$(CC) -S $< -o $@

%.o: ../%.asm
	tarn-elf32-as $< -o $@

clean:
	rm -f *.o *.asm *.lst *~ $(CLEANSPEC) *.dump* *.asm *.lib

distclean: clean
	rm -f Makefile

